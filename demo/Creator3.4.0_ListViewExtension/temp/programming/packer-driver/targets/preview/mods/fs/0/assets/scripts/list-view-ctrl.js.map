{"version":3,"sources":["file:///F:/GitHub/ZheFengZhang/CococsCreator%20public%20technology%20solutions/demo/Creator3.4.0_ScrollviewExtension/assets/scripts/list-view-ctrl.ts"],"names":["_decorator","Component","Node","ScrollView","Label","Button","Vec3","UITransform","instantiate","error","ccclass","property","menu","_temp_vec3","ListViewCtrl","onLoad","_content","scrollView","content","initialize","_updateTimer","_updateInterval","_lastContentPosY","_itemTemplateUITrans","itemTemplate","_uiProps","uiTransformComp","_contentUITrans","height","totalCount","spacing","i","spawnCount","item","addChild","itemUITrans","setPosition","labelComp","getComponentInChildren","string","_items","push","getPositionInView","worldPos","parent","getComponent","convertToWorldSpaceAR","position","viewPos","node","convertToNodeSpaceAR","update","dt","items","buffer","bufferZone","isDown","y","offset","length","getPosition","lblTotalItems","addItem","removeItem","moveBottomItemToTop","getItemAtBottom","scrollToFixedPosition","scrollToOffset"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, ScrollView, Label, Button, Vec3, UITransform, instantiate, error } from \"cc\";\r\nconst { ccclass, property, menu } = _decorator;\r\n\r\nconst _temp_vec3 = new Vec3();\r\n\r\n@ccclass(\"ListViewCtrl\")\r\n@menu('UI/ListViewCtrl')\r\nexport class ListViewCtrl extends Component {\r\n    @property(Node)\r\n    public itemTemplate: Node  = null!;\r\n    @property(ScrollView)\r\n    public scrollView: ScrollView  = null!;\r\n    @property\r\n    public spawnCount = 0; // 初始化 item 数量\r\n    @property\r\n    public totalCount = 0; // 滚动列表里总的 item 数量\r\n    @property\r\n    public spacing = 0; // item 垂直排布间隔\r\n    @property\r\n    public bufferZone = 0; // when item is away from bufferZone, we relocate it\r\n    @property(Button)\r\n    public btnAddItem: Button  = null!;\r\n    @property(Button)\r\n    public btnRemoveItem: Button  = null!;\r\n    @property(Button)\r\n    public btnJumpToPosition: Button  = null!;\r\n    @property(Label)\r\n    public lblJumpPosition: Label  = null!;\r\n    @property(Label)\r\n    public lblTotalItems: Label  = null!;\r\n\r\n    private _content: Node = null!;\r\n    private _items: Node[] = [];\r\n    private _updateTimer = 0;\r\n    private _updateInterval = 0.2;\r\n    private _lastContentPosY = 0;\r\n    private _itemTemplateUITrans!: UITransform;\r\n    private _contentUITrans!: UITransform;\r\n\r\n    onLoad() {\r\n        this._content = this.scrollView.content!;\r\n        this.initialize();\r\n        this._updateTimer = 0;\r\n        this._updateInterval = 0.2;\r\n        this._lastContentPosY = 0; // use this variable to detect if we are scrolling up or down\r\n    }\r\n\r\n    // 初始化 item\r\n    initialize() {\r\n        this._itemTemplateUITrans = this.itemTemplate._uiProps.uiTransformComp!;\r\n        this._contentUITrans = this._content._uiProps.uiTransformComp!;\r\n        this._contentUITrans.height = this.totalCount * (this._itemTemplateUITrans.height + this.spacing) + this.spacing; // get total content height\r\n        for (let i = 0; i < this.spawnCount; ++i) { // spawn items, we only need to do this once\r\n            let item = instantiate(this.itemTemplate) as Node;\r\n            this._content.addChild(item);\r\n            let itemUITrans = item._uiProps.uiTransformComp!;\r\n            item.setPosition(0, -itemUITrans.height * (0.5 + i) - this.spacing * (i + 1), 0);\r\n            const labelComp = item.getComponentInChildren(Label)!;\r\n            labelComp.string = `item_${i}`;\r\n            this._items.push(item);\r\n        }\r\n    }\r\n\r\n    getPositionInView(item: Node) {\r\n        // get item position in scrollview's node space\r\n        let worldPos = item.parent!.getComponent(UITransform)!.convertToWorldSpaceAR(item.position);\r\n        let viewPos = this.scrollView.node.getComponent(UITransform)!.convertToNodeSpaceAR(worldPos);\r\n        return viewPos;\r\n    }\r\n\r\n    update(dt: number) {\r\n        this._updateTimer += dt;\r\n        if (this._updateTimer < this._updateInterval) return; // we don't need to do the math every frame\r\n        this._updateTimer = 0;\r\n        let items = this._items;\r\n        let buffer = this.bufferZone;\r\n        let isDown = this.scrollView.content!.position.y < this._lastContentPosY; // scrolling direction\r\n        let offset = (this._itemTemplateUITrans.height + this.spacing) * items.length;\r\n        for (let i = 0; i < items.length; ++i) {\r\n            let viewPos = this.getPositionInView(items[i]);\r\n            items[i].getPosition(_temp_vec3);\r\n            if (isDown) {\r\n                // if away from buffer zone and not reaching top of content\r\n                if (viewPos.y < -buffer && _temp_vec3.y + offset < 0) {\r\n                    _temp_vec3.y += offset;\r\n                    items[i].setPosition(_temp_vec3);\r\n                }\r\n            } else {\r\n                // if away from buffer zone and not reaching bottom of content\r\n                if (viewPos.y > buffer && _temp_vec3.y - offset > -this._contentUITrans.height) {\r\n                    _temp_vec3.y -= offset;\r\n                    items[i].setPosition(_temp_vec3);\r\n                }\r\n            }\r\n        }\r\n        // update lastContentPosY\r\n        this._lastContentPosY = this.scrollView.content!.position.y;\r\n        this.lblTotalItems.string = \"Total Items: \" + this.totalCount;\r\n    }\r\n\r\n    addItem() {\r\n        this._contentUITrans.height = (this.totalCount + 1) * (this._itemTemplateUITrans.height + this.spacing) + this.spacing; // get total content height\r\n        this.totalCount = this.totalCount + 1;\r\n    }\r\n\r\n    removeItem() {\r\n        if (this.totalCount - 1 < 30) {\r\n            error(\"can't remove item less than 30!\");\r\n            return;\r\n        }\r\n\r\n        this._contentUITrans.height = (this.totalCount - 1) * (this._itemTemplateUITrans.height + this.spacing) + this.spacing; // get total content height\r\n        this.totalCount = this.totalCount - 1;\r\n\r\n        this.moveBottomItemToTop();\r\n    }\r\n\r\n    moveBottomItemToTop() {\r\n        let offset = (this._itemTemplateUITrans.height + this.spacing) * this._items.length;\r\n        let length = this._items.length;\r\n        let item = this.getItemAtBottom();\r\n        item.getPosition(_temp_vec3);\r\n\r\n        // whether need to move to top\r\n        if (_temp_vec3.y + offset < 0) {\r\n            _temp_vec3.y = _temp_vec3.y + offset;\r\n            item.setPosition(_temp_vec3);\r\n        }\r\n    }\r\n\r\n    getItemAtBottom() {\r\n        let item = this._items[0];\r\n        for (let i = 1; i < this._items.length; ++i) {\r\n            if (item.position.y > this._items[i].position.y) {\r\n                item = this._items[i];\r\n            }\r\n        }\r\n        return item;\r\n    }\r\n\r\n    scrollToFixedPosition() {\r\n        this.scrollView.scrollToOffset(new Vec3(0, 500, 0), 2, true);\r\n    }\r\n}\r\n\r\n"]}