{"version":3,"sources":["file:///F:/GitHub/ZheFengZhang/CococsCreator%20public%20technology%20solutions/demo/Creator3.4.0_PartialScreenshot/assets/script/Canvas2Image.ts"],"names":["_decorator","ccclass","property","Canvas2Image","getInstance","$support","canvas","document","createElement","ctx","getContext","imageData","getImageData","dataURL","toDataURL","btoa","window","downloadMime","scaleCanvas","width","height","w","h","undefined","retCanvas","retCtx","drawImage","getDataURL","type","saveFile","strData","fileName","fileDownload","genImage","img","src","fixType","toLowerCase","replace","r","match","encodeData","data","str","i","length","String","fromCharCode","makeURI","genBitmapImage","oData","biWidth","biHeight","biSizeImage","bfSize","BITMAPFILEHEADER","BITMAPINFOHEADER","iPadding","aImgData","strPixelData","biWidth4","y","iOffsetY","strPixelRow","x","iOffsetX","c","strEncoded","concat","saveAsImage","quality","getElementById","test","toBlob","blob","url","URL","createObjectURL","convertToImage","downloadUrl","aLink","style","display","href","download","body","appendChild","click","removeChild","saveAsPNG","saveAsJPEG","saveAsGIF","saveAsBMP","convertToPNG","convertToJPEG","convertToGIF","convertToBMP"],"mappings":"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","sourcesContent":["import { _decorator } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n@ccclass('Canvas2Image')\r\nexport class Canvas2Image {\r\n    public static getInstance() {\r\n        // check if support sth.\r\n        var $support = function () {\r\n            var canvas = document.createElement('canvas'),\r\n                ctx = canvas.getContext('2d');\r\n\r\n            return {\r\n                canvas: !!ctx,\r\n                imageData: !!ctx.getImageData,\r\n                dataURL: !!canvas.toDataURL,\r\n                btoa: !!window.btoa\r\n            };\r\n        }();\r\n\r\n        var downloadMime = 'image/octet-stream';\r\n\r\n        function scaleCanvas(canvas, width, height) {\r\n            var w = canvas.width,\r\n                h = canvas.height;\r\n            if (width == undefined) {\r\n                width = w;\r\n            }\r\n            if (height == undefined) {\r\n                height = h;\r\n            }\r\n\r\n            var retCanvas = document.createElement('canvas');\r\n            var retCtx = retCanvas.getContext('2d');\r\n            retCanvas.width = width;\r\n            retCanvas.height = height;\r\n            retCtx.drawImage(canvas, 0, 0, w, h, 0, 0, width, height);\r\n            return retCanvas;\r\n        }\r\n\r\n        function getDataURL(canvas, type, width, height) {\r\n            canvas = scaleCanvas(canvas, width, height);\r\n            return canvas.toDataURL(type);\r\n        }\r\n\r\n        function saveFile(strData, type, fileName) {\r\n            // document.location.href = strData;\r\n            fileDownload(strData, type, fileName);\r\n        }\r\n\r\n        function genImage(strData) {\r\n            var img = document.createElement('img');\r\n            img.src = strData;\r\n            return img;\r\n        }\r\n        function fixType(type) {\r\n            type = type.toLowerCase().replace(/jpg/i, 'jpeg');\r\n            var r = type.match(/png|jpeg|bmp|gif/)[0];\r\n            return 'image/' + r;\r\n        }\r\n        function encodeData(data) {\r\n            if (!window.btoa) { throw 'btoa undefined' }\r\n            var str = '';\r\n            if (typeof data == 'string') {\r\n                str = data;\r\n            } else {\r\n                for (var i = 0; i < data.length; i++) {\r\n                    str += String.fromCharCode(data[i]);\r\n                }\r\n            }\r\n\r\n            return btoa(str);\r\n        }\r\n        function getImageData(canvas) {\r\n            var w = canvas.width,\r\n                h = canvas.height;\r\n            return canvas.getContext('2d').getImageData(0, 0, w, h);\r\n        }\r\n        function makeURI(strData, type) {\r\n            return 'data:' + type + ';base64,' + strData;\r\n        }\r\n\r\n\r\n        /**\r\n         * create bitmap image\r\n         * 按照规则生成图片响应头和响应体\r\n         */\r\n        var genBitmapImage = function (oData) {\r\n\r\n            //\r\n            // BITMAPFILEHEADER: http://msdn.microsoft.com/en-us/library/windows/desktop/dd183374(v=vs.85).aspx\r\n            // BITMAPINFOHEADER: http://msdn.microsoft.com/en-us/library/dd183376.aspx\r\n            //\r\n\r\n            var biWidth = oData.width;\r\n            var biHeight = oData.height;\r\n            var biSizeImage = biWidth * biHeight * 3;\r\n            var bfSize = biSizeImage + 54; // total header size = 54 bytes\r\n\r\n            //\r\n            //  typedef struct tagBITMAPFILEHEADER {\r\n            //  \tWORD bfType;\r\n            //  \tDWORD bfSize;\r\n            //  \tWORD bfReserved1;\r\n            //  \tWORD bfReserved2;\r\n            //  \tDWORD bfOffBits;\r\n            //  } BITMAPFILEHEADER;\r\n            //\r\n            var BITMAPFILEHEADER = [\r\n                // WORD bfType -- The file type signature; must be \"BM\"\r\n                0x42, 0x4D,\r\n                // DWORD bfSize -- The size, in bytes, of the bitmap file\r\n                bfSize & 0xff, bfSize >> 8 & 0xff, bfSize >> 16 & 0xff, bfSize >> 24 & 0xff,\r\n                // WORD bfReserved1 -- Reserved; must be zero\r\n                0, 0,\r\n                // WORD bfReserved2 -- Reserved; must be zero\r\n                0, 0,\r\n                // DWORD bfOffBits -- The offset, in bytes, from the beginning of the BITMAPFILEHEADER structure to the bitmap bits.\r\n                54, 0, 0, 0\r\n            ];\r\n\r\n            //\r\n            //  typedef struct tagBITMAPINFOHEADER {\r\n            //  \tDWORD biSize;\r\n            //  \tLONG  biWidth;\r\n            //  \tLONG  biHeight;\r\n            //  \tWORD  biPlanes;\r\n            //  \tWORD  biBitCount;\r\n            //  \tDWORD biCompression;\r\n            //  \tDWORD biSizeImage;\r\n            //  \tLONG  biXPelsPerMeter;\r\n            //  \tLONG  biYPelsPerMeter;\r\n            //  \tDWORD biClrUsed;\r\n            //  \tDWORD biClrImportant;\r\n            //  } BITMAPINFOHEADER, *PBITMAPINFOHEADER;\r\n            //\r\n            var BITMAPINFOHEADER = [\r\n                // DWORD biSize -- The number of bytes required by the structure\r\n                40, 0, 0, 0,\r\n                // LONG biWidth -- The width of the bitmap, in pixels\r\n                biWidth & 0xff, biWidth >> 8 & 0xff, biWidth >> 16 & 0xff, biWidth >> 24 & 0xff,\r\n                // LONG biHeight -- The height of the bitmap, in pixels\r\n                biHeight & 0xff, biHeight >> 8 & 0xff, biHeight >> 16 & 0xff, biHeight >> 24 & 0xff,\r\n                // WORD biPlanes -- The number of planes for the target device. This value must be set to 1\r\n                1, 0,\r\n                // WORD biBitCount -- The number of bits-per-pixel, 24 bits-per-pixel -- the bitmap\r\n                // has a maximum of 2^24 colors (16777216, Truecolor)\r\n                24, 0,\r\n                // DWORD biCompression -- The type of compression, BI_RGB (code 0) -- uncompressed\r\n                0, 0, 0, 0,\r\n                // DWORD biSizeImage -- The size, in bytes, of the image. This may be set to zero for BI_RGB bitmaps\r\n                biSizeImage & 0xff, biSizeImage >> 8 & 0xff, biSizeImage >> 16 & 0xff, biSizeImage >> 24 & 0xff,\r\n                // LONG biXPelsPerMeter, unused\r\n                0, 0, 0, 0,\r\n                // LONG biYPelsPerMeter, unused\r\n                0, 0, 0, 0,\r\n                // DWORD biClrUsed, the number of color indexes of palette, unused\r\n                0, 0, 0, 0,\r\n                // DWORD biClrImportant, unused\r\n                0, 0, 0, 0\r\n            ];\r\n\r\n            var iPadding = (4 - ((biWidth * 3) % 4)) % 4;\r\n\r\n            var aImgData = oData.data;\r\n\r\n            var strPixelData = '';\r\n            var biWidth4 = biWidth << 2;\r\n            var y = biHeight;\r\n            var fromCharCode = String.fromCharCode;\r\n\r\n            do {\r\n                var iOffsetY = biWidth4 * (y - 1);\r\n                var strPixelRow = '';\r\n                for (var x = 0; x < biWidth; x++) {\r\n                    var iOffsetX = x << 2;\r\n                    strPixelRow += fromCharCode(aImgData[iOffsetY + iOffsetX + 2]) +\r\n                        fromCharCode(aImgData[iOffsetY + iOffsetX + 1]) +\r\n                        fromCharCode(aImgData[iOffsetY + iOffsetX]);\r\n                }\r\n\r\n                for (var c = 0; c < iPadding; c++) {\r\n                    strPixelRow += String.fromCharCode(0);\r\n                }\r\n\r\n                strPixelData += strPixelRow;\r\n            } while (--y);\r\n\r\n            var strEncoded = encodeData(BITMAPFILEHEADER.concat(BITMAPINFOHEADER)) + encodeData(strPixelData);\r\n\r\n            return strEncoded;\r\n        };\r\n\r\n        /**\r\n         * saveAsImage\r\n         * @param canvasElement\r\n         * @param {String} image type\r\n         * @param {Number} [optional] png width\r\n         * @param {Number} [optional] png height\r\n         */\r\n        var saveAsImage = function (canvas, width, height, type, fileName) {\r\n            /**\r\n             * canvas.toBlob 的第三个参数。当请求图片格式为image/jpeg或者image/webp时用来指定图片展示质量。\r\n             * 如果这个参数的值不在指定类型与范围之内，则使用默认值，其余参数将被忽略。\r\n             * 此处暂时默认设置为 1\r\n             */\r\n            var quality = 1.0;\r\n            if ($support.canvas && $support.dataURL) {\r\n                if (typeof canvas == \"string\") { canvas = document.getElementById(canvas); }\r\n                if (type == undefined) { type = 'png'; }\r\n                type = fixType(type);\r\n                if (/bmp/.test(type)) {\r\n                    var data = getImageData(scaleCanvas(canvas, width, height));\r\n                    var strData = genBitmapImage(data);\r\n                    saveFile(makeURI(strData, downloadMime), type.replace(\"image/\", \"\"), fileName);\r\n                } else {\r\n                    \r\n                    canvas = scaleCanvas(canvas, width, height);\r\n                    // 如果\r\n                    canvas.toBlob(function(blob){\r\n                        var url = URL.createObjectURL(blob);\r\n                        saveFile(url, type.replace(\"image/\", \"\"), fileName);\r\n                    }, type, quality)\r\n                }\r\n            }\r\n        };\r\n\r\n        var convertToImage = function (canvas, width, height, type) {\r\n            if ($support.canvas && $support.dataURL) {\r\n                if (typeof canvas == \"string\") { canvas = document.getElementById(canvas); }\r\n                if (type == undefined) { type = 'png'; }\r\n                type = fixType(type);\r\n\r\n                if (/bmp/.test(type)) {\r\n                    var data = getImageData(scaleCanvas(canvas, width, height));\r\n                    var strData = genBitmapImage(data);\r\n                    return genImage(makeURI(strData, 'image/bmp'));\r\n                } else {\r\n                    var strData: string = getDataURL(canvas, type, width, height);\r\n                    return genImage(strData);\r\n                }\r\n            }\r\n        };\r\n\r\n        var fileDownload = function (downloadUrl, type, fileName) {\r\n            let aLink = document.createElement('a');\r\n            aLink.style.display = 'none';\r\n            aLink.href = downloadUrl;\r\n            aLink.download = fileName + \".\" + type;\r\n            // 触发点击-然后移除\r\n            document.body.appendChild(aLink);\r\n            aLink.click();\r\n            document.body.removeChild(aLink);\r\n        }\r\n\r\n\r\n\r\n        return {\r\n            saveAsImage: saveAsImage,\r\n            saveAsPNG: function (canvas, width, height) {\r\n                return saveAsImage(canvas, width, height, 'png', 'defaultpng');\r\n            },\r\n            saveAsJPEG: function (canvas, width, height) {\r\n                return saveAsImage(canvas, width, height, 'jpeg', 'defaultjpg');\r\n            },\r\n            saveAsGIF: function (canvas, width, height) {\r\n                return saveAsImage(canvas, width, height, 'gif', 'defaultgif');\r\n            },\r\n            saveAsBMP: function (canvas, width, height) {\r\n                return saveAsImage(canvas, width, height, 'bmp', 'defaultbmp');\r\n            },\r\n\r\n            convertToImage: convertToImage,\r\n            convertToPNG: function (canvas, width, height) {\r\n                return convertToImage(canvas, width, height, 'png');\r\n            },\r\n            convertToJPEG: function (canvas, width, height) {\r\n                return convertToImage(canvas, width, height, 'jpeg');\r\n            },\r\n            convertToGIF: function (canvas, width, height) {\r\n                return convertToImage(canvas, width, height, 'gif');\r\n            },\r\n            convertToBMP: function (canvas, width, height) {\r\n                return convertToImage(canvas, width, height, 'bmp');\r\n            }\r\n        };\r\n    }\r\n}"]}